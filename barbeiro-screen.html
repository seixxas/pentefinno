<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda Geral - PENTEFINO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            background-color: #0f0f0f;
            color: #e0e0e0;
            padding-top: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .stats-card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 25px;
        }

        .card-agendamento {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            color: white;
            border-left: 4px solid #d4af37;
            /* Dourado Barbearia */
            transition: transform 0.2s;
        }

        .card-agendamento:hover {
            transform: translateY(-5px);
            border-color: #d4af37;
        }

        .badge-date {
            background-color: #d4af37;
            color: #000;
            font-weight: bold;
        }

        .btn-cancel {
            color: #ff6b6b;
            border: 1px solid #ff6b6b;
            background: transparent;
        }

        .btn-cancel:hover {
            background: #ff6b6b;
            color: white;
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="stats-card d-flex justify-content-between align-items-center shadow-sm">
            <div>
                <h4 class="mb-0 text-white">Agenda PenteFino</h4>
                <small class="text-muted" id="total-count">Carregando agendamentos...</small>
            </div>
            <button class="btn btn-outline-light btn-sm" onclick="carregarAgenda()">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
        </div>

        <div id="lista-agendamentos" class="row g-3">
        </div>
    </div>

    <script>
        const pass = prompt("Digite a senha de acesso ao painel:");
        if (pass !== "gubielinha") {
            alert("Acesso negado");
            window.location.href = "/";
        }

        async function carregarAgenda() {
            const container = document.getElementById('lista-agendamentos');
            const totalDisplay = document.getElementById('total-count');
            container.innerHTML = '<div class="text-center w-100 mt-5"><div class="spinner-border text-warning"></div></div>';

            try {
                const res = await fetch('/api/get-agendamentos');
                const dados = await res.json();

                totalDisplay.textContent = `${dados.length} agendamento(s) no total`;

                if (dados.length === 0) {
                    container.innerHTML = '<div class="text-center mt-5 text-muted"><i class="bi bi-inbox display-1"></i><p>Nenhum agendamento para mostrar.</p></div>';
                    return;
                }

                container.innerHTML = dados.map(a => `
                <div class="col-12 col-md-6 col-lg-4" id="card-${a.id}">
                    <div class="card card-agendamento h-100 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="badge badge-date">${formatarData(a.date)} às ${a.time}</span>
                                <small class="text-warning">${a.barber || 'Profissional'}</small>
                            </div>
                            
                            <h5 class="card-title text-white mb-1">
                                <i class="bi bi-person-fill small"></i> ${a.name || 'Cliente'}
                            </h5>
                            
                            <p class="mb-2" style="color: #25d366; font-weight: 500;">
                                <i class="bi bi-whatsapp"></i> ${a.phone || 'Sem telefone'}
                            </p>

                            <p class="small text-secondary mb-3">
                                <i class="bi bi-scissors"></i> ${a.service || 'Serviço não informado'}
                            </p>
                            
                            <div class="d-flex gap-2">
                                <a href="https://wa.me/${a.phone}" target="_blank" class="btn btn-sm btn-outline-success flex-grow-1">
                                    <i class="bi bi-chat-dots"></i> Contatar
                                </a>
                                <button onclick="cancelar(${a.id})" class="btn btn-sm btn-cancel">
                                    <i class="bi bi-trash3"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            } catch (error) {
                container.innerHTML = '<p class="text-danger text-center">Erro de conexão com o servidor.</p>';
            }
        }

        async function cancelar(id) {
            if (!confirm("Confirmar cancelamento deste horário?")) return;

            try {
                const res = await fetch('/api/delete-agendamento', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                });

                if (res.ok) {
                    const card = document.getElementById(`card-${id}`);
                    card.style.opacity = '0';
                    setTimeout(() => {
                        card.remove();
                        carregarAgenda(); // Atualiza contador
                    }, 300);
                }
            } catch (err) { alert("Erro ao cancelar."); }
        }

        function formatarData(dataISO) {
            if (!dataISO) return "--/--";
            const partes = dataISO.split('T')[0].split('-');
            return `${partes[2]}/${partes[1]}`;
        }

        carregarAgenda();
    </script>
</body>

</html>